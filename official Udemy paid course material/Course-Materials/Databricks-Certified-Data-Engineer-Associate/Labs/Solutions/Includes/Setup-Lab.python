{"version":"NotebookV1","origId":325513904362645,"name":"Setup-Lab","language":"python","commands":[{"version":"CommandV1","origId":325513904362646,"guid":"dc3968be-6899-4eb6-b2fd-5548da7dc863","subtype":"command","commandType":"auto","position":0.5,"command":"data_source_uri = \"wasbs://course-resources@dalhussein.blob.core.windows.net/datasets/school/v1/\"\ndataset_school = 'dbfs:/mnt/DE-Associate/datasets/school'\ncheckpoint_path = 'dbfs:/mnt/DE-Associate/checkpoints/school'\ndlt_path = 'dbfs:/mnt/DE-Associate/dlt/school'\ndb_name = 'DE_Associate_School'\ndlt_db_name = 'DE_Associate_School_DLT'\nspark.conf.set(f\"dataset.school\", dataset_school)","commandVersion":18,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"1b6f66e9-94e8-41cb-9b82-de4c3370cd20"},{"version":"CommandV1","origId":325513904362647,"guid":"6c84287a-4f7b-4215-bf40-d24f4a2a35d0","subtype":"command","commandType":"auto","position":1.0,"command":"def clean_up():\n    print(\"Removing Checkpoints ...\")\n    dbutils.fs.rm(checkpoint_path, True)\n    print(\"Removing DLT storage location ...\")\n    dbutils.fs.rm(dlt_path, True)\n    print(\"Dropping Database ...\")\n    spark.sql(f\"DROP SCHEMA IF EXISTS {db_name} CASCADE\")\n    print(\"Dropping DLT database ...\")\n    spark.sql(f\"DROP SCHEMA IF EXISTS {dlt_db_name} CASCADE\")\n    print(\"Removing Dataset ...\")\n    dbutils.fs.rm(dataset_school, True)\n    print(\"Done\")","commandVersion":12,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"cb67f539-0206-45d1-8de8-308677e736fe"},{"version":"CommandV1","origId":325513904362648,"guid":"9643a259-4fd6-414b-9c9d-0529d20eed0f","subtype":"command","commandType":"auto","position":1.5,"command":"try:\n    clean = int(dbutils.widgets.get(\"clean\"))\nexcept:\n    clean = 0\n\nif clean:\n    clean_up()","commandVersion":52,"state":"finished","results":{"type":"listResults","data":[],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1694354572250,"submitTime":1694354572230,"finishTime":1694354572526,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{"rowLimit":10000,"byteLimit":2048000},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"a6ceb287-6345-4826-acca-92679721e2f1"},{"version":"CommandV1","origId":325513904362649,"guid":"69f08c24-e689-4465-ad5a-8674c22719e9","subtype":"command","commandType":"auto","position":2.0,"command":"def path_exists(path):\n  try:\n    dbutils.fs.ls(path)\n    return True\n  except Exception as e:\n    if 'java.io.FileNotFoundException' in str(e):\n      return False\n    else:\n      raise","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"ee354ed6-5863-4e0e-997f-81a91dc42fd8"},{"version":"CommandV1","origId":325513904362650,"guid":"00d552f6-fdaf-4a79-a671-55fdb66dbcd8","subtype":"command","commandType":"auto","position":3.0,"command":"def download_dataset(source, target):\n    files = dbutils.fs.ls(source)\n\n    for f in files:\n        source_path = f\"{source}/{f.name}\"\n        target_path = f\"{target}/{f.name}\"\n        if not path_exists(target_path):\n            print(f\"Copying {f.name} ...\")\n            dbutils.fs.cp(source_path, target_path, True)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"49ea93ab-e6d2-4f91-b45c-5589b6f3990c"},{"version":"CommandV1","origId":325513904362651,"guid":"ceb485fd-522a-4bed-8526-1d47df0527c9","subtype":"command","commandType":"auto","position":5.0,"command":"def get_index(dir):\n    files = dbutils.fs.ls(dir)\n    index = 0\n    if files:\n        file = max(files).name\n        index = int(file.rsplit('.', maxsplit=1)[0])\n    return index+1","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"e618bfba-990e-4208-8108-3f4d75bf14d7"},{"version":"CommandV1","origId":325513904362652,"guid":"609f5ade-fd0c-4d36-9906-3b266d7394a6","subtype":"command","commandType":"auto","position":6.0,"command":"# Structured Streaming\nstreaming_dir = f\"{dataset_school}/enrollments-streaming\"\nraw_dir = f\"{dataset_school}/enrollments-raw\"\n\ndef load_file(current_index):\n    latest_file = f\"{str(current_index).zfill(2)}.parquet\"\n    print(f\"Loading {latest_file} file to the school dataset\")\n    dbutils.fs.cp(f\"{streaming_dir}/{latest_file}\", f\"{raw_dir}/{latest_file}\")\n\n    \ndef load_new_data(all=False):\n    index = get_index(raw_dir)\n    if index >= 10:\n        print(\"No more data to load\\n\")\n\n    elif all == True:\n        while index <= 10:\n            load_file(index)\n            index += 1\n    else:\n        load_file(index)\n        index += 1","commandVersion":5,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"cb51512f-0d8a-467b-bc8c-fdf567d0b2b8"},{"version":"CommandV1","origId":325513904362653,"guid":"6cb46be5-db77-4beb-848f-fe9b74ab1ac8","subtype":"command","commandType":"auto","position":7.0,"command":"# DLT\nstreaming_enrollments_dir = f\"{dataset_school}/enrollments-json-streaming\"\nstreaming_courses_dir = f\"{dataset_school}/courses-streaming\"\n\nraw_enrollments_dir = f\"{dataset_school}/enrollments-json-raw\"\nraw_courses_dir = f\"{dataset_school}/courses-cdc\"\n\ndef load_json_file(current_index):\n    latest_file = f\"{str(current_index).zfill(2)}.json\"\n    print(f\"Loading {latest_file} enrollments file to the school dataset\")\n    dbutils.fs.cp(f\"{streaming_enrollments_dir}/{latest_file}\", f\"{raw_enrollments_dir}/{latest_file}\")\n    #print(f\"Loading {latest_file} courses file to the school dataset\")\n    #dbutils.fs.cp(f\"{streaming_courses_dir}/{latest_file}\", f\"{raw_courses_dir}/{latest_file}\")\n\n    \ndef load_new_json_data(all=False):\n    index = get_index(raw_enrollments_dir)\n    if index >= 10:\n        print(\"No more data to load\\n\")\n\n    elif all == True:\n        while index <= 10:\n            load_json_file(index)\n            index += 1\n    else:\n        load_json_file(index)\n        index += 1","commandVersion":25,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"d1165413-3a58-461c-8e7a-060aeddc033d"},{"version":"CommandV1","origId":325513904362654,"guid":"4c22f5cc-9d53-4a53-abff-47fc36511613","subtype":"command","commandType":"auto","position":7.5,"command":"","commandVersion":16,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"a39f1ed5-ce7e-4bba-ad13-34e68e035bb2"},{"version":"CommandV1","origId":325513904362655,"guid":"1d78a128-0ec3-41f2-9e39-4cd11688cef1","subtype":"command","commandType":"auto","position":8.0,"command":"download_dataset(data_source_uri, dataset_school)\n\nspark.sql(f\"CREATE SCHEMA IF NOT EXISTS {db_name}\")\nspark.sql(f\"USE {db_name}\")\nprint(f\"Schema for the hands-on labs: {db_name}\")","commandVersion":40,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"a2966457-3620-4928-972e-fdae834d611b"},{"version":"CommandV1","origId":325513904362656,"guid":"736c2274-e937-4981-b723-03ae43bf85a8","subtype":"command","commandType":"auto","position":11.0,"command":"","commandVersion":22,"state":"error","results":{"type":"listResults","data":[],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":"<span class='ansi-red-fg'>NameError</span>: name 'clean_up' is not defined","errorTraceType":"ansi","error":"\u001B[0;31m---------------------------------------------------------------------------\u001B[0m\n\u001B[0;31mNameError\u001B[0m                                 Traceback (most recent call last)\nFile \u001B[0;32m<command-2030504645145160>:1\u001B[0m\n\u001B[0;32m----> 1\u001B[0m \u001B[43mclean_up\u001B[49m()\n\n\u001B[0;31mNameError\u001B[0m: name 'clean_up' is not defined","workflows":[],"startTime":1694353291519,"submitTime":1694353291519,"finishTime":1694353291967,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{"rowLimit":10000,"byteLimit":2048000},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"791f23f3-2ef6-4490-9a5d-11cef0e10344"},{"version":"CommandV1","origId":325513904362657,"guid":"cba9058d-180f-4e76-93e0-572585e1ebdf","subtype":"command","commandType":"auto","position":12.0,"command":"","commandVersion":0,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"27af6c89-4007-4033-af85-d59a117cab99"}],"dashboards":[],"guid":"b6b4d2bd-0aab-4b4a-9857-4f751a68f8ad","globalVars":{},"iPythonMetadata":null,"inputWidgets":{},"notebookMetadata":{"pythonIndentUnit":4,"mostRecentlyExecutedCommandWithImplicitDF":{"commandId":2030504645145127,"dataframes":["_sqldf"]}},"reposExportFormat":"SOURCE"}