{"version":"NotebookV1","origId":325513904362818,"name":"4.1L Solution - Delta Live Tables","language":"sql","commands":[{"version":"CommandV1","origId":325513904362819,"guid":"003da961-fe0c-4ca5-a691-7c55e848c298","subtype":"command","commandType":"auto","position":2.0,"command":"%md\n\n## Lab Solution: implementing a DLT pipeline\n\n> This notebook is **not intended** to be executed interactively, but rather to be deployed as a DLT pipeline from the **workflows** tab\n\n\n* Help: <a href=\"https://docs.databricks.com/en/delta-live-tables/tutorial-sql.html\" target=\"_blank\">DLT syntax documentation</a>.","commandVersion":42,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"d1b034eb-3ddd-4f6d-9e1e-d59478bd8d0e"},{"version":"CommandV1","origId":325513904362820,"guid":"24e6f57e-148d-4747-9fe1-787bbc26162f","subtype":"command","commandType":"auto","position":2.125,"command":"%md-sandbox\n\n<div  style=\"text-align: center; line-height: 0; padding-top: 9px;\">\n  <img src=\"https://raw.githubusercontent.com/derar-alhussein/Databricks-Certified-Data-Engineer-Associate/main/Labs/Includes/images/school_schema.png\" alt=\"School Schema\" style=\"width: 600\">\n</div>","commandVersion":2,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"2d6d54cb-57f1-4bd0-92c4-c840a94281cb"},{"version":"CommandV1","origId":325513904362821,"guid":"60fd2659-5890-429e-975b-130336f4bf6c","subtype":"command","commandType":"auto","position":2.25,"command":"%md\n#### Q1- Declaring Bronze Tables\n\nDeclare a streaming live table, **`enrollments_bronze`**, that ingests JSON data incrementally using Auto Loader from the directory **\"${datasets_path}/enrollments-json-raw\"**","commandVersion":27,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"7360706e-19b2-40a1-b895-417cf0f54229"},{"version":"CommandV1","origId":325513904362822,"guid":"10bd63af-595d-4f94-a7ec-bbb33f0d0013","subtype":"command","commandType":"auto","position":2.625,"command":"-- ANSWER\nCREATE OR REFRESH STREAMING LIVE TABLE enrollments_bronze\nAS SELECT * FROM cloud_files(\"${dataset_path}/enrollments-json-raw\", \"json\",\n                             map(\"cloudFiles.inferColumnTypes\", \"true\"))","commandVersion":31,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"35cb4e74-cf57-4fea-8a79-0b12f3938a4b"},{"version":"CommandV1","origId":325513904362823,"guid":"8843bdca-322d-4563-a953-a733bf58fd46","subtype":"command","commandType":"auto","position":2.71875,"command":"%md\nDeclare a live table, **`students_bronze`**, that load data directly from JSON files in the directory **\"${datasets_path}/students-json\"**","commandVersion":21,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"82b03230-8b27-4efa-9613-987f90ac775b"},{"version":"CommandV1","origId":325513904362824,"guid":"b68300dc-8280-44f0-be57-4caa45f461e8","subtype":"command","commandType":"auto","position":2.8125,"command":"-- ANSWER\nCREATE OR REFRESH LIVE TABLE students_bronze\nAS SELECT * FROM json.`${dataset_path}/students-json`","commandVersion":15,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"2f7a23d2-a340-499f-a7bd-dea1cb881528"},{"version":"CommandV1","origId":325513904362825,"guid":"fbb60484-73ad-4add-aa3a-cbda13be60e8","subtype":"command","commandType":"auto","position":2.90625,"command":"%md\n#### Q2 - Declaring Silver Table\n\nDeclare a streaming live table, **`enrollments_cleaned`**, that:\n\n1. Enrich the **enrollments_bronze** data through an inner join with the **`students_bronze`** table on the common **`student_id`** field to obtain the student's country\n1. Implement quality control by applying a constraint to drop records with a null **`email`**\n1. The table will have the following schema:\n\n| Field | Type |\n| --- | --- |\n| **`enroll_id`** | **`STRING`** |\n| **`total`** | **`DOUBLE`** |\n| **`email`** | **`STRING`** |\n| **`country`** | **`STRING`** |\n","commandVersion":111,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"5f67b1c4-34b0-4b19-8f58-fc475fcc74ec"},{"version":"CommandV1","origId":325513904362826,"guid":"16459667-ce6a-4267-887a-ab3c1a43815b","subtype":"command","commandType":"auto","position":2.953125,"command":"-- ANSWER\nCREATE OR REFRESH STREAMING LIVE TABLE enrollments_cleaned (\n  CONSTRAINT valid_email EXPECT (email IS NOT NULL) ON VIOLATION DROP ROW\n)\nAS SELECT enroll_id, total, email, profile:address:country as country\n  FROM STREAM(LIVE.enrollments_bronze) n\n  LEFT JOIN LIVE.students_bronze s\n    ON n.student_id = s.student_id","commandVersion":89,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"eb4f340f-898b-423b-b632-5b8002364e24"},{"version":"CommandV1","origId":325513904362827,"guid":"acc5ccab-581c-46d1-984b-8277d444c2d9","subtype":"command","commandType":"auto","position":2.9765625,"command":"%md\n### Q3- Declaring Gold Table\n\nDeclare a live table, **`course_sales_per_country`** against **`enrollments_cleaned`** that calculate per **`country`** the following:\n* **`enrollments_count`**: the number of enrollments\n* **`enrollments_amount`**: the sum of the total amount of enrollments\n\nAdd a comment to the table: \"Course Sales Per Country\"","commandVersion":110,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"77194f04-e07c-4b5d-a77b-44c0186bab7f"},{"version":"CommandV1","origId":325513904362828,"guid":"a2e8dbd2-7628-42cd-aa59-dd5846493028","subtype":"command","commandType":"auto","position":2.98828125,"command":"-- ANSWER\nCREATE OR REFRESH LIVE TABLE course_sales_per_country\nCOMMENT \"Course Sales Per Country\"\nAS\n  SELECT country, count(enroll_id) AS enrollments_count, sum(total) AS enrollments_amount\n  FROM LIVE.enrollments_cleaned\n  GROUP BY country","commandVersion":47,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"2ef50552-e590-48ff-b347-7effb22ce501"},{"version":"CommandV1","origId":325513904362829,"guid":"b9508e6b-b0a1-48c1-958b-05da9eacbb20","subtype":"command","commandType":"auto","position":3.98828125,"command":"%md\n### Q4- Deploying DLT pipeline\n\nFrom the **Workflows** button on the sidebar, under the **Delta Live Tables** tab, click **Create Pipeline**\n\nConfigure the pipeline settings specified below:\n\n| Setting | Instructions |\n|--|--|\n| Pipeline name | School DLT |\n| Product edition | Choose **Advanced** |\n| Pipeline mode | Choose **Triggered** |\n| Source code | Use the navigator to select this current notebook (4.1L - Delta Live Tables) |\n| Storage location | dbfs:/mnt/DE-Associate/dlt/school |\n| Target schema | DE_Associate_School_DLT |\n| Cluster policy | Leave it **None**|\n| Cluster mode | Choose **Fixed size**|\n| Workers | Enter **0**|\n| Photon Acceleration | Leave it unchecked |\n| Advanced Configuration | Click **Add Configuration** and enter:<br> - Key: **dataset_path** <br> - Value: **dbfs:/mnt/DE-Associate/datasets/school** |\n| Channel | Choose **Current**|\n\nFinally, click **Create**.","commandVersion":118,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"8206436a-a87e-4682-bef8-3a92c8605a4c"},{"version":"CommandV1","origId":325513904362830,"guid":"4d521fa7-3b00-45dd-ba7e-bcac21923d64","subtype":"command","commandType":"auto","position":4.98828125,"command":"%md\n### Q5 - Run your Pipeline\n\nSelect **Development** mode and Click **Start** to begin the update to your pipeline's tables","commandVersion":27,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"ed8136b4-3967-4fbb-825d-86c5dcf6f376"}],"dashboards":[],"guid":"d7347860-325b-4436-b7f0-a8d16551c903","globalVars":{},"iPythonMetadata":null,"inputWidgets":{},"notebookMetadata":{"pythonIndentUnit":4},"reposExportFormat":"SOURCE"}