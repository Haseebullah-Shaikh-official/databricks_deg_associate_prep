{"version":"NotebookV1","origId":325513904362947,"name":"Setup-Lab","language":"python","commands":[{"version":"CommandV1","origId":325513904362948,"guid":"64f5b365-ff14-4ad3-9322-882c7d7b45ed","subtype":"command","commandType":"auto","position":0.5,"command":"data_source_uri = \"wasbs://course-resources@dalhussein.blob.core.windows.net/datasets/school/v1/\"\ndataset_school = 'dbfs:/mnt/DE-Associate/datasets/school'\ncheckpoint_path = 'dbfs:/mnt/DE-Associate/checkpoints/school'\ndlt_path = 'dbfs:/mnt/DE-Associate/dlt/school'\ndb_name = 'DE_Associate_School'\ndlt_db_name = 'DE_Associate_School_DLT'\nspark.conf.set(f\"dataset.school\", dataset_school)","commandVersion":18,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"1b6f66e9-94e8-41cb-9b82-de4c3370cd20"},{"version":"CommandV1","origId":325513904362949,"guid":"72d6893b-3ebf-4d35-927c-016bb28fbf39","subtype":"command","commandType":"auto","position":1.0,"command":"def clean_up():\n    print(\"Removing Checkpoints ...\")\n    dbutils.fs.rm(checkpoint_path, True)\n    print(\"Removing DLT storage location ...\")\n    dbutils.fs.rm(dlt_path, True)\n    print(\"Dropping Database ...\")\n    spark.sql(f\"DROP SCHEMA IF EXISTS {db_name} CASCADE\")\n    print(\"Dropping DLT database ...\")\n    spark.sql(f\"DROP SCHEMA IF EXISTS {dlt_db_name} CASCADE\")\n    print(\"Removing Dataset ...\")\n    dbutils.fs.rm(dataset_school, True)\n    print(\"Done\")","commandVersion":12,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"cb67f539-0206-45d1-8de8-308677e736fe"},{"version":"CommandV1","origId":325513904362950,"guid":"8032a99a-2373-480f-9b77-d56a9d718b0d","subtype":"command","commandType":"auto","position":1.5,"command":"try:\n    clean = int(dbutils.widgets.get(\"clean\"))\nexcept:\n    clean = 0\n\nif clean:\n    clean_up()","commandVersion":52,"state":"finished","results":{"type":"listResults","data":[],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1694354572250,"submitTime":1694354572230,"finishTime":1694354572526,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{"rowLimit":10000,"byteLimit":2048000},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"a6ceb287-6345-4826-acca-92679721e2f1"},{"version":"CommandV1","origId":325513904362951,"guid":"96a934d3-1cb3-41b5-a8c5-be6829c09a55","subtype":"command","commandType":"auto","position":2.0,"command":"def path_exists(path):\n  try:\n    dbutils.fs.ls(path)\n    return True\n  except Exception as e:\n    if 'java.io.FileNotFoundException' in str(e):\n      return False\n    else:\n      raise","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"ee354ed6-5863-4e0e-997f-81a91dc42fd8"},{"version":"CommandV1","origId":325513904362952,"guid":"c80af43b-a90d-4ea8-9096-d1ed5e004eb1","subtype":"command","commandType":"auto","position":3.0,"command":"def download_dataset(source, target):\n    files = dbutils.fs.ls(source)\n\n    for f in files:\n        source_path = f\"{source}/{f.name}\"\n        target_path = f\"{target}/{f.name}\"\n        if not path_exists(target_path):\n            print(f\"Copying {f.name} ...\")\n            dbutils.fs.cp(source_path, target_path, True)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"49ea93ab-e6d2-4f91-b45c-5589b6f3990c"},{"version":"CommandV1","origId":325513904362953,"guid":"81004501-2684-4afc-ac1d-d1462e14cdf9","subtype":"command","commandType":"auto","position":5.0,"command":"def get_index(dir):\n    files = dbutils.fs.ls(dir)\n    index = 0\n    if files:\n        file = max(files).name\n        index = int(file.rsplit('.', maxsplit=1)[0])\n    return index+1","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"e618bfba-990e-4208-8108-3f4d75bf14d7"},{"version":"CommandV1","origId":325513904362954,"guid":"868c506a-8ed6-4a1d-94bb-ecb323f64f0d","subtype":"command","commandType":"auto","position":6.0,"command":"# Structured Streaming\nstreaming_dir = f\"{dataset_school}/enrollments-streaming\"\nraw_dir = f\"{dataset_school}/enrollments-raw\"\n\ndef load_file(current_index):\n    latest_file = f\"{str(current_index).zfill(2)}.parquet\"\n    print(f\"Loading {latest_file} file to the school dataset\")\n    dbutils.fs.cp(f\"{streaming_dir}/{latest_file}\", f\"{raw_dir}/{latest_file}\")\n\n    \ndef load_new_data(all=False):\n    index = get_index(raw_dir)\n    if index >= 10:\n        print(\"No more data to load\\n\")\n\n    elif all == True:\n        while index <= 10:\n            load_file(index)\n            index += 1\n    else:\n        load_file(index)\n        index += 1","commandVersion":5,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"cb51512f-0d8a-467b-bc8c-fdf567d0b2b8"},{"version":"CommandV1","origId":325513904362955,"guid":"08a6851d-2aed-46db-bbed-6fc60003980f","subtype":"command","commandType":"auto","position":7.0,"command":"# DLT\nstreaming_enrollments_dir = f\"{dataset_school}/enrollments-json-streaming\"\nstreaming_courses_dir = f\"{dataset_school}/courses-streaming\"\n\nraw_enrollments_dir = f\"{dataset_school}/enrollments-json-raw\"\nraw_courses_dir = f\"{dataset_school}/courses-cdc\"\n\ndef load_json_file(current_index):\n    latest_file = f\"{str(current_index).zfill(2)}.json\"\n    print(f\"Loading {latest_file} enrollments file to the school dataset\")\n    dbutils.fs.cp(f\"{streaming_enrollments_dir}/{latest_file}\", f\"{raw_enrollments_dir}/{latest_file}\")\n    #print(f\"Loading {latest_file} courses file to the school dataset\")\n    #dbutils.fs.cp(f\"{streaming_courses_dir}/{latest_file}\", f\"{raw_courses_dir}/{latest_file}\")\n\n    \ndef load_new_json_data(all=False):\n    index = get_index(raw_enrollments_dir)\n    if index >= 10:\n        print(\"No more data to load\\n\")\n\n    elif all == True:\n        while index <= 10:\n            load_json_file(index)\n            index += 1\n    else:\n        load_json_file(index)\n        index += 1","commandVersion":25,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"d1165413-3a58-461c-8e7a-060aeddc033d"},{"version":"CommandV1","origId":325513904362956,"guid":"9976ef52-ac35-435e-8ea9-b3a8d9f02116","subtype":"command","commandType":"auto","position":7.5,"command":"","commandVersion":16,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"a39f1ed5-ce7e-4bba-ad13-34e68e035bb2"},{"version":"CommandV1","origId":325513904362957,"guid":"710597cd-f249-4cb5-abc8-d6f5e1dc5b6d","subtype":"command","commandType":"auto","position":8.0,"command":"download_dataset(data_source_uri, dataset_school)\n\nspark.sql(f\"CREATE SCHEMA IF NOT EXISTS {db_name}\")\nspark.sql(f\"USE {db_name}\")\nprint(f\"Schema for the hands-on labs: {db_name}\")","commandVersion":40,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"a2966457-3620-4928-972e-fdae834d611b"},{"version":"CommandV1","origId":325513904362958,"guid":"fe085473-b7ff-48f5-afe5-74e6c7352a65","subtype":"command","commandType":"auto","position":11.0,"command":"","commandVersion":22,"state":"error","results":{"type":"listResults","data":[],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":"<span class='ansi-red-fg'>NameError</span>: name 'clean_up' is not defined","errorTraceType":"ansi","error":"\u001B[0;31m---------------------------------------------------------------------------\u001B[0m\n\u001B[0;31mNameError\u001B[0m                                 Traceback (most recent call last)\nFile \u001B[0;32m<command-2030504645145160>:1\u001B[0m\n\u001B[0;32m----> 1\u001B[0m \u001B[43mclean_up\u001B[49m()\n\n\u001B[0;31mNameError\u001B[0m: name 'clean_up' is not defined","workflows":[],"startTime":1694353291519,"submitTime":1694353291519,"finishTime":1694353291967,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{"rowLimit":10000,"byteLimit":2048000},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"791f23f3-2ef6-4490-9a5d-11cef0e10344"},{"version":"CommandV1","origId":325513904362959,"guid":"c56607f9-30c5-41fc-b875-0e308f82d18f","subtype":"command","commandType":"auto","position":12.0,"command":"","commandVersion":0,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"27af6c89-4007-4033-af85-d59a117cab99"}],"dashboards":[],"guid":"bf3f3874-443e-4e0f-a438-8c593f7dfb62","globalVars":{},"iPythonMetadata":null,"inputWidgets":{},"notebookMetadata":{"pythonIndentUnit":4,"mostRecentlyExecutedCommandWithImplicitDF":{"commandId":2030504645145127,"dataframes":["_sqldf"]}},"reposExportFormat":"SOURCE"}