{"version":"NotebookV1","origId":1806376725234577,"name":"Copy-Datasets","language":"python","commands":[{"version":"CommandV1","origId":1567829344281797,"guid":"357011eb-a7f1-4a7b-8617-3451e40ea2db","subtype":"command","commandType":"auto","position":2.0,"command":"def path_exists(path):\n  try:\n    dbutils.fs.ls(path)\n    return True\n  except Exception as e:\n    if 'java.io.FileNotFoundException' in str(e):\n      return False\n    else:\n      raise","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"05a353bd-7e41-4d8a-9f1c-c12fb8d5b2f5"},{"version":"CommandV1","origId":1567829344281798,"guid":"d5b8c632-20e4-4825-8d5e-ee7ab67786da","subtype":"command","commandType":"auto","position":3.0,"command":"def download_dataset(source, target):\n    files = dbutils.fs.ls(source)\n\n    for f in files:\n        source_path = f\"{source}/{f.name}\"\n        target_path = f\"{target}/{f.name}\"\n        if not path_exists(target_path):\n            print(f\"Copying {f.name} ...\")\n            dbutils.fs.cp(source_path, target_path, True)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"a562b23b-82a0-43b5-b7d0-2b591dde6c35"},{"version":"CommandV1","origId":1567829344281799,"guid":"84a41be5-c7af-4829-89e5-f33e922438e3","subtype":"command","commandType":"auto","position":4.0,"command":"data_source_uri = \"wasbs://course-resources@dalhussein.blob.core.windows.net/datasets/bookstore/v1/\"\ndataset_bookstore = 'dbfs:/mnt/demo-datasets/bookstore'\nspark.conf.set(f\"dataset.bookstore\", dataset_bookstore)","commandVersion":3,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"df6b9dd8-0444-496a-84c3-eef60ba22139"},{"version":"CommandV1","origId":1567829344281800,"guid":"b5d8e0ce-f844-4454-baf2-764dd608b8e8","subtype":"command","commandType":"auto","position":5.0,"command":"def get_index(dir):\n    files = dbutils.fs.ls(dir)\n    index = 0\n    if files:\n        file = max(files).name\n        index = int(file.rsplit('.', maxsplit=1)[0])\n    return index+1","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"ee823e7e-6ec8-432a-9352-d7eec5de7548"},{"version":"CommandV1","origId":1567829344281801,"guid":"8c4c5139-ec36-4a61-ba84-1c385b10e367","subtype":"command","commandType":"auto","position":6.0,"command":"# Structured Streaming\nstreaming_dir = f\"{dataset_bookstore}/orders-streaming\"\nraw_dir = f\"{dataset_bookstore}/orders-raw\"\n\ndef load_file(current_index):\n    latest_file = f\"{str(current_index).zfill(2)}.parquet\"\n    print(f\"Loading {latest_file} file to the bookstore dataset\")\n    dbutils.fs.cp(f\"{streaming_dir}/{latest_file}\", f\"{raw_dir}/{latest_file}\")\n\n    \ndef load_new_data(all=False):\n    index = get_index(raw_dir)\n    if index >= 10:\n        print(\"No more data to load\\n\")\n\n    elif all == True:\n        while index <= 10:\n            load_file(index)\n            index += 1\n    else:\n        load_file(index)\n        index += 1","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"de79afb0-126c-4222-bc90-3c0944ace75d"},{"version":"CommandV1","origId":1567829344281802,"guid":"136272d4-ca98-4a38-9829-6c50bf9af5bd","subtype":"command","commandType":"auto","position":7.0,"command":"# DLT\nstreaming_orders_dir = f\"{dataset_bookstore}/orders-json-streaming\"\nstreaming_books_dir = f\"{dataset_bookstore}/books-streaming\"\n\nraw_orders_dir = f\"{dataset_bookstore}/orders-json-raw\"\nraw_books_dir = f\"{dataset_bookstore}/books-cdc\"\n\ndef load_json_file(current_index):\n    latest_file = f\"{str(current_index).zfill(2)}.json\"\n    print(f\"Loading {latest_file} orders file to the bookstore dataset\")\n    dbutils.fs.cp(f\"{streaming_orders_dir}/{latest_file}\", f\"{raw_orders_dir}/{latest_file}\")\n    print(f\"Loading {latest_file} books file to the bookstore dataset\")\n    dbutils.fs.cp(f\"{streaming_books_dir}/{latest_file}\", f\"{raw_books_dir}/{latest_file}\")\n\n    \ndef load_new_json_data(all=False):\n    index = get_index(raw_orders_dir)\n    if index >= 10:\n        print(\"No more data to load\\n\")\n\n    elif all == True:\n        while index <= 10:\n            load_json_file(index)\n            index += 1\n    else:\n        load_json_file(index)\n        index += 1","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"041bcd75-c824-4739-990c-59a9a308b2ca"},{"version":"CommandV1","origId":1567829344281803,"guid":"2566800c-3777-4722-b481-8b3575591532","subtype":"command","commandType":"auto","position":8.0,"command":"download_dataset(data_source_uri, dataset_bookstore)","commandVersion":1,"state":"finished","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"5ced790a-755b-4811-acfe-95389efc4d61"}],"dashboards":[],"guid":"02bce464-52d9-4c82-af26-5d27d7c8c105","globalVars":{},"iPythonMetadata":null,"inputWidgets":{},"notebookMetadata":{"pythonIndentUnit":4},"reposExportFormat":"SOURCE"}